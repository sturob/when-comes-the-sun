<html> 
  <head> 
    <title>When Comes the Sun</title> 

    <meta name="viewport" content="user-scalable=no, width=device-width" />

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js">    
    </script>

    <!-- script type="text/javascript" src="http://ip-geo.appspot.com/geo_data.js"></script -->

    <script type="text/javascript">

      /**
       * Cookie plugin
       *
       * Copyright (c) 2006 Klaus Hartl (stilbuero.de)
       * Dual licensed under the MIT and GPL licenses:
       * http://www.opensource.org/licenses/mit-license.php
       * http://www.gnu.org/licenses/gpl.html
       *
       */

      /**
       * Create a cookie with the given name and value and other optional parameters.
       *
       * @example $.cookie('the_cookie', 'the_value');
       * @desc Set the value of a cookie.
       * @example $.cookie('the_cookie', 'the_value', { expires: 7, path: '/', domain: 'jquery.com', secure: true });
       * @desc Create a cookie with all available options.
       * @example $.cookie('the_cookie', 'the_value');
       * @desc Create a session cookie.
       * @example $.cookie('the_cookie', null);
       * @desc Delete a cookie by passing null as value. Keep in mind that you have to use the same path and domain
       *       used when the cookie was set.
       *
       * @param String name The name of the cookie.
       * @param String value The value of the cookie.
       * @param Object options An object literal containing key/value pairs to provide optional cookie attributes.
       * @option Number|Date expires Either an integer specifying the expiration date from now on in days or a Date object.
       *                             If a negative value is specified (e.g. a date in the past), the cookie will be deleted.
       *                             If set to null or omitted, the cookie will be a session cookie and will not be retained
       *                             when the the browser exits.
       * @option String path The value of the path atribute of the cookie (default: path of page that created the cookie).
       * @option String domain The value of the domain attribute of the cookie (default: domain of page that created the cookie).
       * @option Boolean secure If true, the secure attribute of the cookie will be set and the cookie transmission will
       *                        require a secure protocol (like HTTPS).
       * @type undefined
       *
       * @name $.cookie
       * @cat Plugins/Cookie
       * @author Klaus Hartl/klaus.hartl@stilbuero.de
       */

      /**
       * Get the value of a cookie with the given name.
       *
       * @example $.cookie('the_cookie');
       * @desc Get the value of a cookie.
       *
       * @param String name The name of the cookie.
       * @return The value of the cookie.
       * @type String
       *
       * @name $.cookie
       * @cat Plugins/Cookie
       * @author Klaus Hartl/klaus.hartl@stilbuero.de
       */
      jQuery.cookie = function(name, value, options) {
          if (typeof value != 'undefined') { // name and value given, set cookie
              options = options || {};
              if (value === null) {
                  value = '';
                  options.expires = -1;
              }
              var expires = '';
              if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
                  var date;
                  if (typeof options.expires == 'number') {
                      date = new Date();
                      date.setTime(date.getTime() + (options.expires * 24 * 60 * 60 * 1000));
                  } else {
                      date = options.expires;
                  }
                  expires = '; expires=' + date.toUTCString(); // use expires attribute, max-age is not supported by IE
              }
              // CAUTION: Needed to parenthesize options.path and options.domain
              // in the following expressions, otherwise they evaluate to undefined
              // in the packed version for some reason...
              var path = options.path ? '; path=' + (options.path) : '';
              var domain = options.domain ? '; domain=' + (options.domain) : '';
              var secure = options.secure ? '; secure' : '';
              document.cookie = [name, '=', encodeURIComponent(value), expires, path, domain, secure].join('');
          } else { // only name given, get cookie
              var cookieValue = null;
              if (document.cookie && document.cookie != '') {
                  var cookies = document.cookie.split(';');
                  for (var i = 0; i < cookies.length; i++) {
                      var cookie = jQuery.trim(cookies[i]);
                      // Does this cookie string begin with the name we want?
                      if (cookie.substring(0, name.length + 1) == (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
      };
      
      
      var SUNTIME = [
        [], // no summertime
        [ "28 March", "31 October" ], // europe
        [ "22 March 2010", "22 September" ], // iran
        [ "3 October", "4 April"], // australias
        [ "26 September", "4 April"], // nz
        [ "31 October", "14 March"], // cuba
        [ "31 October", "4 April"], // mexico
        [ "3 October", "14 March"], // uruguay
        [ "17 October", "21 February" ],  // brazil
        [ "4 April", "10 October" ],  // chile
        [ "14 March", "7 November" ]  // US + canada
      ];
      
      
      var PST = -8,
          MST = -7,
          CST = -6,
          EST = -5,
          BRST = -3,
          ART  = -3,
          GMT  = 0,
          CET  = 1,   // central europe
          WAT = 1,    // west afr
          EET  = 2,   // east europe
          SAST = 2,   // s africa
          EAT = 3,
          MSD = 3,    // moscow
          AST = 3,    // arabia
          IRT = 3.5,  // iran
          IST  = 5.5, // india
          CNST  = 8,   // china
          WST = 8,  // west aus
          JST = 9,  // japan
          ACST = 9.5, // aus central
          AEST = 10,  // aus eastern
          NZST = 12;
          

      var DB = {
        // long, lat, time_offset, summerzone
        "Europe": false,
        
        "Amsterdam, Netherlands":       [  52.22,    4.53,  CET,  1 ],
        "Athens, Greece":               [  37.58,   23.43,  EET,  1 ],
        "Barcelona, Spain":             [  41.23,    2.90,  CET,  1 ],
        "Belfast, Northern Ireland":    [  54.37,   -5.56,  GMT,  1 ],
        "Belgrade, Serbia":             [  44.52,   20.32,  CET,  1 ],
        "Birmingham, England":          [  52.25,   -1.55,  GMT,  1 ],
        "Brussels, Belgium":            [  50.52,    4.22,  CET,  1 ],
        "Bucharest, Romania":           [  44.25,   26.70,  EET,  1 ],
        "Budapest, Hungary":            [  47.30,   19.50,  CET,  1 ],
        "Copenhagen, Denmark":          [  55.40,   12.34,  CET,  1 ],
        "Dublin, Ireland":              [  53.20,   -6.15,  GMT,  1 ],
        "Edinburgh, Scotland":          [  55.55,   -3.10,  GMT,  1 ],
        "Frankfurt, Germany":           [   50.7,    8.41,  CET,  1 ],
        "Glasgow, Scotland":            [  55.50,   -4.15,  GMT,  1 ],
        "Hamburg, Germany":             [  53.33,   10.20,  CET,  1 ],
        "Helsinki, Finland":            [  60.10,   25.00,  EET,  1 ],
        "Lisbon, Portugal":             [  38.44,   -9.90,  GMT,  1 ],
        "Liverpool, England":           [  53.25,   -3.00,  GMT,  1 ],
        "London, England":              [  51.32,   -0.50,  GMT,  1 ],
        "Lyons, France":                [  45.45,    4.50,  CET,  1 ],
        "Kiev, Ukraine":                [  50.27,   30.31,  CET,  1 ],
        "Madrid, Spain":                [  40.26,   -3.42,  CET,  1 ],
        "Manchester, England":          [  53.30,   -2.15,  GMT,  1 ],
        "Marseilles, France":           [  43.20,    5.20,  CET,  1 ],
        "Milan, Italy":                 [  45.27,    9.10,  CET,  1 ],
        "Moscow, Russia":               [  55.45,   37.36,  MSD,  1 ],
        "Munich, Germany":              [  48.8,    11.35,  CET,  1 ],
        "Naples, Italy":                [  40.50,   14.15,  CET,  1 ], 
        "Oslo, Norway":                 [  59.57,   10.42,  CET,  1 ],
        "Paris, France":                [  48.48,    2.20,  CET,  1 ],
        "Reykjavik, Iceland":           [  64.40,  -21.58,  GMT,  0 ],
        "Sofia, Bulgaria":              [  42.40,   23.20,  EET,  1 ],
        "Prague, Czech Republic":       [  50.50,   14.26,  CET,  1 ],
        "Rome, Italy":                  [  41.54,   12.27,  CET,  1 ],
        "St. Petersburg, Russia":       [  59.56,   30.18,  MSD,  1 ],
        "Stockholm, Sweden":            [  59.17,   18.30,  CET,  1 ],
        "Venice, Italy":                [  45.26,   12.20,  CET,  1 ],
        "Vienna, Austria":              [  48.14,   16.20,  CET,  1 ],
        "Vladivostok, Russia":          [  43.10,  132.00,   10,  1 ],
        "Warsaw, Poland":               [  52.14,   21.00,  CET,  1 ],
        "Zurich, Switzerland":          [  47.21,    8.31,  CET,  1 ],

        "Africa": false,
        
        "Algiers, Algeria":             [  36.00,    3.00,  CET ],
        "Cairo, Egypt":                 [  30.20,   31.21,  EET ],
        "Cape Town, South Africa":      [ -33.55,   18.22,  SAST ],
        "Dakar, Senegal":               [  14.40,  -17.28,  GMT ],
        "Djibouti, Djibouti":           [  11.30,   43.30,  EAT ],
        "Durban, South Africa":         [ -29.53,   30.53,  SAST ],
        "Johannesburg, South Africa":   [ -26.12,   28.40,  SAST ],
        "Kinshasa, Congo":              [  -4.18,   15.17,  WAT ],
        "Lagos, Nigeria":               [   6.27,    3.23,  WAT ],
        "Nairobi, Kenya":               [  -1.25,   36.55,  EAT ],
        "Tripoli, Libya":               [  32.57,   13.12,  EET ],
                                                               
        "Ankara, Turkey":               [  39.55,   32.55,  EET,  1 ],
        "Istanbul, Turkey":             [  41.01,   28.58,  EET,  1 ],
        "Mecca, Saudi Arabia":          [  21.29,   39.45,  AST,  0 ],
        "Teheran, Iran":                [  35.45,   51.45,  IRT,  2 ],
                  
        "Oceania": false,
                                                               
        "Adelaide, Australia":          [ -34.55,  138.36, ACST,  3 ],
        "Auckland, New Zealand":        [ -36.52,  174.45, NZST,  4 ],
        "Brisbane, Australia":          [ -27.29 , 153.80, AEST,  0 ],
        "Darwin, Australia":            [ -12.28,  130.51, ACST,  0 ],
        "Melbourne, Australia":         [ -37.47 , 144.58, AEST,  3 ],
        "Perth, Australia":             [ -31.57 , 115.52, WST ,  0 ],
        "Sydney, Australia":            [  -34.0,  151.00, AEST,  3 ],
        "Wellington, New Zealand":      [ -41.17,  174.47, NZST,  4 ],
        
        
        "Asia": false,
        
        "Bangkok, Thailand":            [  13.45,  100.30,    7 ],
        "Beijing, China":               [  39.55,  116.25, CNST ], 
        "Calcutta, India":              [  22.34,   88.24,  IST ],
        "Canton, China":                [  23.70,  113.15, CNST ],
        "Chongqing, China":             [  29.46,  106.34, CNST ],
        "Hong Kong, China":             [  22.20,  114.11, CNST ],
        "Jakarta, Indonesia":           [  -6.16,  106.48,    7 ],
        "Kuala Lumpur, Malaysia":       [   3.80,  101.42,    8 ],
        "Manila, Philippines":          [  14.35,  120.57,    8 ],
        "Mumbai, India":                [  19.00,   72.48,  IST ],
        "Nagasaki, Japan":              [  32.48,  129.57,  JST ],
        "Nagoya, Japan":                [  35.7,   136.56,  JST ],
        "Nanjing, China":               [  32.3,   118.53, CNST ],
        "New Delhi, India":             [  28.35,   77.12,  IST ],
        "Osaka, Japan":                 [  34.32,  135.30,  JST ],
     "Port Moresby, Papua New Guinea":  [  -9.25,  147.80,   10 ],
        "Rangoon, Myanmar":             [  16.50,   96.00,  6.5 ],
        "Shanghai, China":              [  31.10,  121.28, CNST ],
        "Singapore, Singapore":         [   1.14,  103.55,    8 ],
        "Seoul, South Korea":           [  37.33,  126.59,    9 ],
        "Tokyo, Japan":                 [  35.40,  139.45,  JST ],
          
        
        "South America": false,
        
        "Bogota, Colombia":             [   4.32,  -74.15,   -5 ],        
        "Buenos Aires, Argentina":      [ -34.35,  -58.22,  ART ],
        "Caracas, Venezuela":           [  10.28,  -67.20, -4.5 ],
        "Cayenne, French Guiana":       [   4.49,  -52.18,   -3 ],
        "Cordoba, Argentina":           [ -31.28,  -64.10,  ART ],
        "Georgetown, Guyana":           [   6.45,  -58.15,   -4 ],
        "Guatemala City, Guatemala":    [  14.37,  -90.31,  CST ],
        "Guayaquil, Ecuador":           [  -2.10,  -79.56,   -5 ],
        "Havana, Cuba":                 [  23.80,  -82.23,   -5,  5 ],
        "Kingston, Jamaica":            [  17.59,  -76.49,   -5 ],
        "La Paz, Bolivia":              [ -16.27,  -68.22,   -4 ],
        "Lima, Peru":                   [ -12.00,  -77.20,   -5 ],
        "Mexico City, Mexico":          [  19.26,  -99.70,  CST,  6 ],
        "Montevideo, Uruguay":          [ -34.53,  -56.10,   -3,  7 ],
        "Panama City, Panama":          [   8.58,  -79.32,  EST ],
        "Paramaribo, Suriname":         [   5.45,  -55.15,   -3 ],
        "Rio de Janeiro, Brazil":       [ -22.57,  -43.12, BRST,  8 ],
        "Salvador, Brazil":             [ -12.56 , -38.27, BRST,  0 ],
        "Santiago, Chile":              [ -33.28,  -70.45,   -4,  9 ],
        "Sao Paulo, Brazil":            [ -23.31,  -46.31, BRST,  8 ],

        "North America": false,
        
        "Atlanta, USA":                 [  33.45,   84.23,  EST, 10 ],
        "Boston, USA":                  [  42.21,   71.50,  EST, 10 ], 
        "Calgary, Canada":              [  51.10,  114.10,  MST, 10 ],
        "Chicago, USA":                 [  41.50,   87.37,  CST, 10 ], 
        "Columbus, USA":                [  34.00, 	81.20,  EST, 10 ],
        "Dallas, USA":                  [  32.46,	  96.46,  CST, 10 ],
        "Detroit, USA":                 [  42.20,	  83.30,  EST, 10 ],
        "Houston, USA":                 [  29.45,	  95.21,  CST, 10 ],
        "Los Angeles, USA":             [  34.30,	 118.15,  PST, 10 ],
        "New York City, USA":           [  40.47,   73.58,  EST, 10 ],
        "New Orleans, USA":             [  29.57,	  90.40,  CST, 10 ],
        "Philadelphia, USA":            [  39.57,	  75.10,  EST, 10 ],
        "Phoenix, USA":                 [  33.29,	 112.40,  MST,  0 ],
        "San Diego, USA":               [  32.42,	 117.10,  PST, 10 ],
        "San Francisco, USA":           [  37.47,	 122.26,  PST, 10 ],
        "Seattle, USA":                 [  47.37,	 122.20,  PST, 10 ],
        "Toronto, Canada":              [  43.40,   79.24,  EST, 10 ],
        "Vancouver, Canada":            [  49.13,  123.06,  PST, 10 ]
      };

      var DESCRIPTION = {
        predawn: "Dawn approaches ",
        dawn: "Day breaks over ",
        morning: "Morning has broken in ",
        day: "The sun hangs over ",
        evening: "The sun tires in ",
        dusk: "Night descends on ",
        night: "Darkness reigns in ",
        twilight: "Twilight hangs over "
      };
      
      Date.prototype.getDayOfTheYear = function() {
        var onejan = new Date(this.getFullYear(),0,1);
        return Math.ceil((this - onejan) / 86400000);
      }
      
      Date.prototype.getMinuteOfTheDay = function() {
        return this.getHours() * 60 + this.getMinutes()
      }
      
      
      
      // -- *D ---
      //
      // These trigonometry functions use degrees instead of radians.
      //
      function sinD(n)  { return Math.sin (n * 0.0174532925199433); }
      function cosD(n)  { return Math.cos (n * 0.0174532925199433); }
      function tanD(n)  { return Math.tan (n * 0.0174532925199433); }
      function asinD(n) { return Math.asin(n) * 57.2957795130823;   }
      function acosD(n) { return Math.acos(n) * 57.2957795130823;   }
      function atanD(n) { return Math.atan(n) * 57.2957795130823;   }


      function Int(n) { return n < 0 ? Math.ceil(n) : Math.floor(n); }
      function Sign(n) { if (n < 0) return -1; if (n > 0) return 1; return 0; }


      // -- isNull --
      //
      // Determines whether an object is null.
      //
      function isNull(anObject)
      {
          return typeof anObject == "object" && !anObject;
      }


      // --- CalculateSunriseOrSunset ---
      //
      // Calculates the time of sunrise or sunset at a given location on a given day.
      //
      // Parameters
      //    latitude - latitude in degrees of location
      //   longitude - longitude in degrees of location
      //        date - Date object - day to calculate
      //     sunrise - Boolean - whether to calculate sunrise (true) or sunset (false)
      //    twilight - Boolean - whether to calculate twilight (true) or sunrise/sunset (false)
      //
      // Returns
      //   floating-point hour of sun event in UTC
      //     (e.g., 5.15 => 0509Z), or null if the event doesn't occur on the given day
      //
      function CalculateSunriseOrSunset(latitude, longitude, date, sunrise, twilight)
      {
          // Source:
          //   Almanac for Computers, 1990
          //   published by Nautical Almanac Office
          //   United States Naval Observatory
          //   Washington, DC 20392

          day   = date.getDate();
          month = date.getMonth() + 1;
          year  = date.getFullYear();

          var zenith;

          if (twilight)
          {
              // twilightSelect = document.getElementById('twilight');
              // zenith = twilightSelect.value;

              // <option id="civilOption" value="96" selected></option>
              // <option id="nauticalOption" value="102"></option>
              // <option id="astronomicalOption" value="108"></option>
              zenith = 99;
          }
          else
              zenith = 90.8333333333;


          // Calculate the day of the year.

          N1 = Math.floor(275.0 * month / 9.0);
          N2 = Math.floor((month + 9.0) / 12.0);
          N3 = 1.0 + Math.floor((year - 4.0 * Math.floor(year / 4.0) + 2.0) / 3.0);
          N = N1 - (N2 * N3) + day - 30.0;


          // Convert the longitude to hour value and calculate an approximate time.

          lngHour = longitude / 15.0;

          if (sunrise)
              t = N + ((6.0 - lngHour) / 24.0);
          else
              t = N + ((18.0 - lngHour) / 24.0)


          // Calculate the sun's mean anomaly.

          M = (0.9856 * t) - 3.289;


          // Calculate the sun's true longitude.

          L = M + (1.916 * sinD(M)) + (0.020 * sinD(2 * M)) + 282.634;

          while (L >= 360) L -= 360.0;
          while (L <  0)   L += 360.0;


          // Caculate the sun's right ascension.

          RA = atanD(0.91764 * tanD(L));

          while (RA >= 360) RA -= 360.0;
          while (RA <  0)   RA += 360.0;


          // Right ascension value needs to be in the same quadrant as L.

          Lquadrant = Math.floor(L / 90.0) * 90.0;
          RAquadrant = Math.floor(RA / 90.0) * 90.0;
          RA = RA + (Lquadrant - RAquadrant);


          // Right ascension value needs to be converted into hours.

          RA /= 15.0;


          // Calculate the sun's declination.

          sinDec = 0.39782 * sinD(L);
          cosDec = cosD(asinD(sinDec));


          // Calculate the sun's local hour angle.

          cosH = (cosD(zenith) - (sinDec * sinD(latitude))) / (cosDec * cosD(latitude));

          if (sunrise)
          {
              if (cosH > 1) return null;
          }
          else
          {
              if (cosH < -1) return null;
          }


          // Finish calculating H and convert into hours.

          if (sunrise)
              H = 360.0 - acosD(cosH);
          else
              H = acosD(cosH);

          H /= 15.0


          // Calculate local mean time of rising.

          T = H + RA - (0.06571 * t) - 6.622;


          // Adjust back to UTC.

          UT = T - lngHour;

          // remove me
          UT += Math.ceil(longitude / 15);
          
          // UT -= DB[LOCATION][2];


          while (UT >= 24) UT -= 24.0;
          while (UT <  0)  UT += 24.0;

          return UT;
      }
      
      // fix me
      function adjust_time_hack(hours) {
        var tmp = hours + DB[LOCATION][2];
        
        while (tmp >= 24) tmp -= 24.0;
        while (tmp <  0)  tmp += 24.0;
        
        return tmp;
      }
      
      
      
      var LOCATION = 'London, England',
          X = 365,
          Y = 24,
          X_SCALE = 1,
          Y_SCALE = 20,
          JAN_FIRST = new Date('2010/01/01'),
          HOUR_IN_MS = 60 * 60 * 1000;
          DAY_IN_MS = HOUR_IN_MS * 24,
          current_day = JAN_FIRST.getTime(),
          LONG = DB[LOCATION][0],
          LAT = DB[LOCATION][1],
          NOW = new Date(),
          ROUGH_TWILIGHT_LENGTH = 0;

      var DST_START, DST_END;
        

      $(window).ready(function() {
        $.each(DB, function(city, ll) {
          if (ll) {
            $('#cities').append("<span>" + city + "</span> ");
          } else {
            $('#cities').append('<h2>' + city + '</h2>');
          }
        });
      
        // $('#cities').hide();

      
        $('#cities span').click(function() {
          var city = $(this).text();
          LOCATION = city;
          LONG = DB[city][0];
          LAT = DB[city][1];
          $('#cities').fadeOut();
          refresh();
        });
      
        $('h1 a').click(function() {
          $('#cities').toggle();
        });

        setInterval(refresh, 20000);      
      });
      

      
      function refresh() {
        // $('#example').height(Y * Y_SCALE).width(X * X_SCALE);
        // alert()
        if (DB[LOCATION][3]){
          DST_START = new Date ( SUNTIME[ DB[LOCATION][3] ][0] + " 2010" );
          DST_END = new Date ( SUNTIME[ DB[LOCATION][3] ][1] + " 2010" );
        } else {
          DST_END = null;
          DST_START = null;
        }
        
        
        var tmp = new Date();
        NOW = new Date( Date.now() + tmp.getTimezoneOffset() * 60 * 1000 );
        current_day = JAN_FIRST.getTime(),
        
        $('h1 span#location').html(LOCATION);
        
        var example = document.getElementById('example');
        var cx = example.getContext('2d');
        cx.clearRect (0, 0, 1000, 1000);

        var previous_state = 'night'; // twilight | day
      
        for (var x=0; x < X; x++) {
          var current_date = new Date(current_day);
          
          var dawn = CalculateSunriseOrSunset(LONG, LAT, current_date, true, true);
          var dusk = CalculateSunriseOrSunset(LONG, LAT, current_date, false, true);
          
          var sunrise = CalculateSunriseOrSunset(LONG, LAT, current_date, true);
          var sunset = CalculateSunriseOrSunset(LONG, LAT, current_date, false);
          
          if (sunset !== null) { // return NaN for solid days :)
            previous_state = 'night'
          } else {
            sunset = 24;
            previous_state = 'day';

            if (dusk !== null) {
              previous_state = 'twilight';
            }
          }
          
          if ((current_date > DST_START) && (current_date < DST_END) ) {
            sunrise += 1;
            sunset += 1;
            dusk += 1;
            dawn += 1;
          }
          
          cx.fillStyle = "rgb(240,240,255)";

          // main daylight
          if (sunrise) {
            cx.fillRect(x * X_SCALE, sunrise * Y_SCALE, X_SCALE, (sunset - sunrise) * Y_SCALE);
          } else {
            if (previous_state == 'day') {
              cx.fillRect(x * X_SCALE, 0, X_SCALE, Y * Y_SCALE);
            }
            // previous_state bug code here
          }
          
          function draw_dawn () {          // dawn twilight
            if (sunrise && dawn) {
              var dawn_length = (sunrise - dawn) * Y_SCALE,
                  dawn_pos = dawn * Y_SCALE,          
                  ROUGH_TWILIGHT_LENGTH = dawn_length;
    
              var dawngrad = cx.createLinearGradient(0, dawn_pos, 0, dawn_length + dawn_pos);  
                  dawngrad.addColorStop(0, '#000028');  
                  dawngrad.addColorStop(1.0, 'rgb(240,240,255)');  

              cx.fillStyle = dawngrad;
              cx.fillRect(x * X_SCALE, dawn_pos, X_SCALE, dawn_length + 1);
            }
          }
          
          function draw_dusk (cx) {
            // dusk twilight
            if (sunset && dusk) {
              var dusk_length = (dusk - sunset) * Y_SCALE,
                  dusk_pos = dusk * Y_SCALE;
          
              var duskgrad = cx.createLinearGradient(0, sunset * Y_SCALE, 0, dusk_pos);  
                  duskgrad.addColorStop(1, '#000028');  
                  duskgrad.addColorStop(0, 'rgb(240,240,255)');  

              cx.fillStyle = duskgrad;
              cx.fillRect(x * X_SCALE, (sunset * Y_SCALE) - 1, X_SCALE, dusk_length);
            }
          }
          
          function draw_permidarkness (cx) {
            // winter permi-darkness
            if (dawn && dusk && ! sunset && ! sunrise) {
              var dawn_pos = dawn * Y_SCALE,
                  dusk_pos = dusk * Y_SCALE;

              var grad = cx.createLinearGradient(0, dawn_pos, 0, dusk_pos);  
                  grad.addColorStop(0, '#000028');  
                  grad.addColorStop(0.3, 'rgb(100,100,110)');  
                  grad.addColorStop(0.7, 'rgb(100,100,110)');  
                  grad.addColorStop(1, '#000028');

              cx.fillStyle = grad;
              cx.fillRect(x * X_SCALE, dawn_pos, X_SCALE, dusk_pos);
            }
          }
          
          function draw_permitwilight(cx){
            // summer night twilight
            if ((sunrise || sunset) && ! dusk && ! dawn) {
              if (sunrise) {
                var dawn_length = sunrise * Y_SCALE;

                var grad = cx.createLinearGradient(0, 0, 0, dawn_length);  
                    grad.addColorStop(0, '#000028');  
                    grad.addColorStop(1.0, 'rgb(240,240,255)');  

                cx.fillStyle = grad;
                cx.fillRect(x * X_SCALE, 0, X_SCALE, dawn_length + 1);
              }
              if (sunset) {
                var dusk_pos = sunset * Y_SCALE;

                var grad = cx.createLinearGradient(0, dusk_pos, 0,  Y);  
                    grad.addColorStop(1.0, '#000028');  
                    grad.addColorStop(0, 'rgb(240,240,255)');  

                cx.fillStyle = grad;
                cx.fillRect(x * X_SCALE, dusk_pos - 1, X_SCALE, Y);
              }
            }
          }
          
          if (LONG < 58) {
            draw_dawn(cx);
            draw_dusk(cx);
          }
          
          draw_permidarkness(cx);
          draw_permitwilight(cx);

          
          current_day += DAY_IN_MS;
        }
        
        // end draw background

        
        
        
        // today line
        cx.fillStyle = "rgba(150, 150, 0, 0.4)";
        cx.fillRect(X_SCALE * NOW.getDayOfTheYear(), 1, 1, Y * Y_SCALE);
                
        // time gridlines
        cx.fillStyle = "rgba(180,180,180,0.2)";
        for (var i = 0; i < 25; ++i) {
          if (i % 6 == 0) { 
            cx.fillRect(0, i * Y_SCALE, X * X_SCALE, 1);
          }
        }
        
        var summertime_offset = (NOW > DST_START && NOW < DST_END) ?  1 : 0;
        
        var guessed_hours = adjust_time_hack(NOW.getMinuteOfTheDay() / 60) + summertime_offset;
        
        var now_minutes_pos = Math.floor(guessed_hours * Y_SCALE);
        // var now_minutes_pos = Math.floor(NOW.getMinuteOfTheDay() / 60 * Y_SCALE);

        // sun right aligned
        cx.fillStyle = "rgba(255,255,0,1)";
        cx.fillRect(X_SCALE * X - 1, now_minutes_pos, X_SCALE, 1);

        // the sun square
        cx.fillStyle = "rgba(0,0,0,0.5)";
        cx.fillRect(
          X_SCALE * NOW.getDayOfTheYear() - 2, now_minutes_pos - 2, 5, 5); 
        cx.fillStyle = "rgb(255,255,0)";
        cx.fillRect(X_SCALE * NOW.getDayOfTheYear() - 1, now_minutes_pos - 1, 3, 3);
        
        
        var sunrise = CalculateSunriseOrSunset(LONG, LAT, NOW, true)        + summertime_offset;
        var sunset  = CalculateSunriseOrSunset(LONG, LAT, NOW, false)       + summertime_offset;
        var dawn    = CalculateSunriseOrSunset(LONG, LAT, NOW, true, true)  + summertime_offset;
        var dusk    = CalculateSunriseOrSunset(LONG, LAT, NOW, false, true) + summertime_offset;
        

        // sun rise + set horizontals
        cx.fillStyle = "rgba(130,130,100,1)";

        cx.fillRect(NOW.getDayOfTheYear() - 2, Math.floor(sunrise * Y_SCALE), 5, 1);
        cx.fillRect(NOW.getDayOfTheYear() - 2, Math.floor(sunset * Y_SCALE), 5, 1);
        
        cx.fillStyle = "rgba(150,150,150,1)";
        
        cx.fillRect(X * X_SCALE, Math.floor(sunrise * Y_SCALE), 12, 1);
        cx.fillRect(X * X_SCALE, Math.floor(sunset * Y_SCALE), 12, 1);
        
        $('#rise').css({ 
          top: Math.floor(sunrise * Y_SCALE) - 8
        }).find('span').text(n_to_hhmm(sunrise));
        
        $('#set').css({
           top: Math.floor(sunset * Y_SCALE) - 8 
        }).find('span').text(n_to_hhmm(sunset));

        // 
        $('#months span#date').text(NOW.getDate()).css({ left: NOW.getMonth() * 30 + 3 });
        $('#times span').text(n_to_hhmm(guessed_hours)).css({ top: now_minutes_pos - 4 });

        // if ()
        // DESCRIPTION[]
        // var $status = $("span#status");
        // 
        // var now_n = time_to_n(NOW);
        // var desc;
        //         
        // if (now_n < sunrise) {
        //   desc = DESCRIPTION.night;
        // } else if (now_n > sunrise && now_n < sunset) {
        //   desc = DESCRIPTION.day;
        // }
        // 
        // if (now_n < sunrise && now_n > dawn) {
        //   desc = DESCRIPTION.dawn;
        // }
        
        

        // $status.text(desc);

        $($('#months div').get(NOW.getMonth())).addClass('ACTIVE');
      }
      
      function time_to_n (t) {
        return t.getHours() +  (t.getMinutes() / 60)
      }
      
      function n_to_time (n) {
        return new Date(HOUR_IN_MS * n);
      }
      
      function time_to_hhmm(t) {
        var mins = t.getMinutes() + "";
        if (mins.length == 1) { mins = "0" + mins; }
        
        return t.getHours() + ":" + mins;
      }

      function n_to_hhmm (n) {
        var both = n.toString().split('.');
        var mins = "0." + (both[1] || 0); // to denominator
        mins *= 60; // to minutes
        mins += ""; // to string
        return both[0] + ":" + Math.floor(mins.length > 1 ? mins : "0" + mins)
      }

    </script> 

    <style type="text/css"> 
      * {
        margin: 0;
        padding: 0;
      }
      
      body {
/*        font-family: Geneva;*/
        font-family: Georgia;
        background: #000028;
/*        padding: 24px 48px;*/
        height: 100%;
      }
      
      h1 {
        font-size: 24px;
        position: absolute;
        top: 24px;
        width: 460px;
        left: 50%;
        margin-left: -235px;
        text-align: center;
        color: #fff;
        font-weight: 100;
        font-family: "Helvetica Neue";
        letter-spacing: 2px;
        z-index: 10;
      }
      
      h1 a {
        text-decoration: underline;
        display: block;
        color: #aaa;
        margin-top: 8px;
        font-size: 12px;
        cursor: pointer;
        
      }
      
      h1 a:hover {
        color: white !important;
      }
      
      #cities {
        font-weight: 100;
        font-family: "Helvetica Neue";
        letter-spacing: 3px;
        display: none;
        position: absolute;
        top: 24px;
/*        background:;*/
        font-size: 14px;
        margin: 48px 24px;
        padding: 24px 24px;
        background: rgba(0,0,0,0.8);
        z-index: 1;
        left: 0;
        color: #ccc;
        line-height: 1.4em;
/*        word-spacing: -5px;*/
/*        text-align: center;*/
        
      }

      #cities h2 {
        font-size: 12px;
        margin-top: 6px;
      }

      #cities span {
        margin-right: 12px;
        letter-spacing: 1px;
/*        display: block;*/
/*        float: left;*/
        white-space: nowrap;
        font-size: 12px;
        
/*        border-bottom: 1px solid #999;*/
/*          padding: 0 12px 0 12px;*/
      }

      #cities span:hover {
        color: white;
        cursor: pointer;
      }

      
      div#main {
        height: 481px;
        position: relative;
        top: 50%;
        left: 0px;
        width: 370px;
        margin: -240px auto 0;
      }
      
      canvas {
        background: #000028;
      }
      
      
      #times {
        position: absolute;
        top: 6px;
        left: -56px;
        color: #335;
/*        left: -6px;*/
        font-size: 18px;
        margin-top: -16px;
        height: 400px;
/*        overflow: hidden;*/
      }
      
      #times div {
        text-align: right;
        height: 120px;
      }
      
      #times span {
        display: block;
        text-align: right;
/*        right: -296px;*/
        margin-top: 0px;
        left: 300px;
/*        text-shadow: 1px 1px 2px #000;*/
        color: #ff0;
        font-size: 18px;
        background: rgba(0,0,40, 0.8);
/*        border: 1px solid #111;*/
        padding: 1px 5px 4px 5px;
/*        font-size: 15px;*/
        -webkit-border-radius: 2px;
        -moz-border-radius: 2px;
        position: absolute;
      }
      
      #months {
        position: absolute;
        bottom: -24px;
        color: #335;
/*        width: 730px;*/
        vertical-align: middle;
        padding-left: 2px;
/*        overflow: hidden;*/
        height: 24px;
/*        outline: 1px solid red;*/
      }
      #months div {
/*        background: black;*/
        height: 24px;
        padding-top: 6px;
        font-size: 12px;
        letter-spacing: -1px;
        width: 30px;
        text-align: center;
        float: left;
        text-transform: uppercase;
      }
      
      #months div.ACTIVE {
        color: #ddd;
      }
      
      #months span {
        position: absolute;
        top: 14px;
        left: 8px;
/*        left: 280px; */
        display: block;
        width: 30px;
        color: #eee;
        text-align: center;
/*        font-size: 11px;*/
      }
      
      #sun {
        font-size: 18px;
        position: absolute;
        top: -4px;
        right: -12px;
        color: #888;
        text-transform: uppercase;
      }
      
      #sun div {
        width: 80px;
        position: absolute;
      }
      
      #sun span {
        margin: 0 4px;
        color: #ccd;
      }

      #sun strong {
        font-weight: normal;
        color: #bbc;
/*        text-decoration: line-through;*/
      }      
      
      #about {
        z-index: -1;
        font-family: Helvetica Neue;
        font-weight: 300;
        position: absolute;
        bottom: 12px;
        width: 100%;
        text-align: center;
        color: #446;
        font-size: 10px;
      }
      
      a {
        color: #446;
      }
    </style> 
  </head> 
   
  <body onload="refresh();"> 
    
    <h1><span id="status"></span> <span id="location">London</span> <a>Change city</a></h1>
    
    <div id="cities">
    </div>
    
    <div id="main">
      <canvas id="example" width="730" height="481">
        This text is displayed if your browser does not support HTML5 Canvas.
      </canvas>
    
      <div id="sun">
        <div id="rise">
           <strong>&uarr;</strong> <span id='sunrise'></span>
        </div>
        <div id="set">
           <strong>&darr;</strong> <span id="sunset"></span>
        </div>
      </div>
    
      <div id="times">
        <div></div>
        <div>6:00</div>
        <div>12:00</div>
        <div>18:00</div>
        <span id="time"></span>
      </div>
    
      <div id="months">
        <div>Jan</div>
        <div>Feb</div>
        <div>Mar</div>
        <div>Apr</div>
        <div>May</div>
        <div>Jun</div>
        <div>Jul</div>
        <div>Aug</div>
        <div>Sep</div>
        <div>Oct</div>
        <div>Nov</div>
        <div>Dec</div>      
        <span id="date"></span>
      </div>
    </div>
    
    <div id="about">
      &copy; <a href="http://sturob.com/">Stuart Robinson</a> 2010
      <!-- div id="share">
        fb
        twitter
        stumbleupon
        delicious
        digg
        -->
    </div>
    
    <script type="text/javascript">
    var clicky = { log: function(){ return; }, goal: function(){ return; }};
    var clicky_site_id = 266178;
    (function() {
      var s = document.createElement('script');
      s.type = 'text/javascript';
      s.async = true;
      s.src = ( document.location.protocol == 'https:' ? 'https://static.getclicky.com/js' : 'http://static.getclicky.com/js' );
      ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
    })();
    </script>
    <a title="Real Time Web Analytics" href="http://getclicky.com/266178"></a>
    <noscript><p><img alt="Clicky" width="1" height="1" src="http://in.getclicky.com/266178ns.gif" /></p></noscript>
    
  </body> 
</html>
